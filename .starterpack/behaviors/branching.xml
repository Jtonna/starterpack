<behavior name="branching" version="1">

  <description>
    Branch naming conventions and strategy definitions. Two strategies exist:
    trunk-based (one branch per ticket) and feature branching (one branch per epic).
    Both strategies always use branches — never commit directly to main.
  </description>

  <applies-to>orchestrator, submitter</applies-to>

  <strategy name="TRUNK_BASED">
    <description>
      For single tickets with small, well-defined scope. One short-lived branch per ticket.
      The branch is created, work is done, and the PR is merged in the same session or shortly after.
    </description>
    <when>
      - The ticket is a single feature, bug, task, or chore
      - The scope fits in one planning/implementation cycle
      - No child tickets or decomposition needed
    </when>
    <flow>
      One ticket → one branch (TYPE/ticket-id) → full lifecycle (PLANNING → IMPLEMENTATION → DOCS → PR) → merge → delete branch
    </flow>
  </strategy>

  <strategy name="FEATURE_BRANCHING">
    <description>
      For epics or large features that decompose into multiple tickets. One long-lived
      feature branch hosts all child ticket work. Child tickets do NOT get their own branches.
    </description>
    <when>
      - The work originated from a SPEC_FILE entry or was identified as an epic during PLANNING/INTAKE
      - Multiple child tickets exist under an epic
    </when>
    <flow>
      Epic ticket → create long-lived branch (EPIC/epic-id) → for each child ticket in dependency order:
        run PLANNING → IMPLEMENTATION on the same branch → close child ticket
      → once all children complete: DOCS (full epic diff against main) → PR → merge → close epic → delete branch
    </flow>
    <rules>
      <rule>All child tickets commit to the epic branch, not their own branches</rule>
      <rule>Each child ticket runs PLANNING → IMPLEMENTATION only (not DOCS or PR)</rule>
      <rule>DOCS runs once after all children are complete, diffing the full epic branch against main</rule>
      <rule>PR runs once at the end for the entire epic, after DOCS</rule>
      <rule>The epic ticket is closed only after all children are closed and the PR is merged</rule>
      <rule>Sub-task progress for each child ticket is tracked as comments on the child ticket</rule>
    </rules>
  </strategy>

  <branch-naming>
    <rule>Never commit directly to main</rule>
    <rule>All commits happen on the feature/epic branch</rule>
    <rule>TYPE is the branch prefix mapped from the ticket's issue_type (see .starterpack/config/beads.xml issue-types)</rule>
    <rule>The orchestrator (team lead) creates the branch during IMPLEMENTATION/LAUNCH (or reuses the epic branch)</rule>

    <examples>
      <!-- Trunk-based: single ticket -->
      <example>git checkout -b FEAT/sp-0004</example>
      <example>git checkout -b BUG/sp-0012</example>
      <!-- Feature branching: epic with children -->
      <example>git checkout -b EPIC/sp-0020</example>
      <!-- Children commit to EPIC/sp-0020, no separate branches -->
    </examples>
  </branch-naming>

  <selection>
    <!--
      The orchestrator determines the strategy during entry point routing (lifecycle/entry.xml):
      - SPEC_FILE entry → FEATURE_BRANCHING (always)
      - EXISTING_TICKET with type "epic" → FEATURE_BRANCHING
      - EXISTING_TICKET with any other type → TRUNK_BASED
      - AD_HOC_REQUEST → TRUNK_BASED (unless the orchestrator determines during PLANNING/INTAKE that it should be an epic)
    -->
  </selection>

</behavior>
